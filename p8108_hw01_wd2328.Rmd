---
title: "Homework 1"
author: "William Donovan"
subtitle: "P8108 - Survival Analysis"
output:
  pdf_document: default
  html_document: default
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(survival)
library(survminer)
library(ggsurvfit)
```

# Question 1

```{r message=FALSE}
# Load in Q1 data
q1_df = read_csv("data/Q1data_extracted.csv")
```

a.  The MLE $\hat\lambda$ for an Exponential distribution is given by:  
    $$
    \hat\lambda = \frac{d}{\sum_i t_i} = \frac{\text{The number of events}}{\text{Person-time: total number of time units observed on all individuals}}
    $$

    Using R to calculate:
    ```{r}
    # Calculate number of events and person-time for relapse
    d_relapse = sum(pull(q1_df, Relapse))
    sum_time_relapse = sum(pull(q1_df, Relapse_Time))
    
    # Calculate relapse MLE
    mle_relapse = d_relapse/sum_time_relapse
    
    # Calculate number of events and person-time for death
    d_death = sum(pull(q1_df, Death))
    sum_time_death = sum(pull(q1_df, Death_Time))
    
    # Calculate death MLE
    mle_death = d_death/sum_time_death
    ```

    `mle_relapse` $\hat\lambda_{relapse}$ = `r round(mle_relapse, 3)`
    
    `mle_death` $\hat\lambda_{death}$ = `r round(mle_death, 3)`
    
    The maximum likelihood estimator $\hat\lambda$ is an estimator for the hazard rate parameter, $\lambda$, which is constant in an exponential distribution. The estimated hazard rate of relapse $\hat\lambda_{relapse}$ is `r round(mle_relapse, 3)` events per month of person-time. The estimated hazard rate of death $\hat\lambda_{death}$ is `r round(mle_death, 3)` events per month of person-time.

b. We can use the MLE to calculate the quantities below.  
    i. **Mean**  
       The expectation, or mean, of the exponential distribution is $\frac{1}{\lambda}$.  
       $$
       \mu_{relapse} = 1/`r round(mle_relapse, 3)` = `r 1/round(mle_relapse, 3)`
       $$
       $$
       \mu_{death} = 1 / `r round(mle_death, 3)` = `r round(1/mle_death, 3)`
       $$
    ii. **Median**  
        The median of an exponential distribution is given by $\tau = \frac{-log(0.5)}{\lambda}$. 
        $$
        \tau_{relapse} = \frac{-log(0.5)}{`r round(mle_relapse, 3)`} = `r round((-1 * log(0.5))/mle_relapse, 3)`
        $$
        $$
        \tau_{death} = \frac{-log(0.5)}{`r round(mle_death, 3)`} = `r round((-1 * log(0.5))/mle_death, 3)`
        $$
    iii. **1 & 2 Year Relapse-Free & Survival Probabilities**  
         These are calculated using the survival functions $S_R(t)$ and $S_D(t)$. Under the exponential distribution $S(t) = e^{-\lambda t}$.
         $$
         S_R(12) = e^{- `r round(mle_relapse, 3)`(12)} = `r round(exp(-mle_relapse * 12), 3)`
         $$
         $$
         S_R(24) = e^{- `r round(mle_relapse, 3)`(24)} = `r round(exp(-mle_relapse * 24), 3)`
         $$
         $$
         S_D(12) = e^{- `r round(mle_death, 3)`(12)} = `r round(exp(-mle_death * 12), 3)`
         $$
         $$
         S_D(24) = e^{- `r round(mle_death, 3)`(24)} = `r round(exp(-mle_death * 24), 3)`
         $$
    iv. **1 & 2 Year Relapse and Death Probabilities**  
        This is easily calculated from the survival function since $F(t) = 1 - S(t)$.
        $$
        F_R(12) = 1 - S_R(12) = `r round(1 - exp(-mle_relapse * 12), 3)`
        $$
        $$
        F_R(24) = 1 - S_R(24) = `r round(1 - exp(-mle_relapse * 24), 3)`
        $$
        $$
        F_D(12) = 1 - S_D(12) = `r round(1 - exp(-mle_death * 12), 3)`
        $$
        $$
        F_D(24) = 1 - S_D(24) = `r round(1 - exp(-mle_death * 24), 3)`
        $$
    v. **Probability of Staying Relapse-Free 2 Years Given 1 Year Relapse-Free**  
       This is a conditional probability denoted as $S_R(24|12)$ and is easily calculated using $S_R(24|12) = S_R(24) / S_R(12)$ since it is certain $S_R(12|24) = 1$. This simplification is shown below.
       $$
       S_R(24|12) = \frac{S_R(24 \cap 12)}{S_R(12)} = \frac{S_R(12|24)S_R(24)}{S_R(12)} = \frac{S_R(24)}{S_R(12)} = \frac{`r round(exp(-mle_relapse * 24), 3)`}{`r round(exp(-mle_relapse * 12), 3)`} = `r round(exp(-mle_relapse * 24) / exp(-mle_relapse * 12), 3)`
       $$
       As expected, $S_R(24|12) = S_R(12)$ since the hazard rate $\lambda$ of an exponential distribution is constant.
    vi. **Median (Using Non-Parametric Methods)**  
        If an exponential distribution is not assumed, the median time-to-event can be calculated using a Kaplan-Meier estimate. However, in this case, only the median time-to-relapse can be calculated. The median time-to-event is given by the smallest $t$ where $\hat{S}(t) \leq 0.5$. For deaths, the KM survival estimator $\hat{S}(t)$ never reaches 0.5, since 7 of 10 observations are censored, and can therefore not be estimated. For relapse, $\hat{S}(t)$ drops to 0.5 at 27 months, so the median time-to-relapse is calculated to be 27 months. This can be confirmed with R:
        ```{r message=FALSE, warning=FALSE}
        km_q1 = survfit(
          Surv(Relapse_Time, Relapse) ~ 1, 
          data = q1_df)
        
        surv_median(km_q1)
        ```

# Question 2

```{r message=FALSE}
# Load in Q2 data
q2_df = read_csv("data/Q2data_extracted.csv")
```

a. Kaplan-Meier Survival Estimate

   ![](images/HW01_Q2a.JPG)

b.
    ```{r}
    # Log-log CI
    km_loglog = survfit2(
      Surv(Value, Binary) ~ 1, 
      data = q2_df, 
      conf.type = "log-log")
    
    summary(km_loglog)
    
    # Linear CI
    km_linear = survfit2(
      Surv(Value, Binary) ~ 1, 
      data = q2_df, 
      conf.type = "plain")
    
    summary(km_linear)
    ```
   
   The "log-log" approach to calculating the 95% confidence intervals is done in order to keep the interval within the [0, 1] bounds of probability. The "linear" approach however is a simple $\hat{S}(t) \pm z_{1-\alpha/2}(SE)$ which can often lead to confidence intervals out of the [0, 1] interval. This does indeed happen with the above Linear CI calculation but the shown interval is truncated at 0.000 and 1.000 by the `survfit2()` function. Using the linear CI calculation, the upper 95% CI at $t_j=2$ is:
   $$
   \hat{S}(t) \pm z_{1-\alpha/2}(SE) = 0.941 + 1.96(0.0571) = 1.053
   $$
   
c.
    ```{r message=FALSE, warning=FALSE}
    km_loglog |>
      ggsurvfit(color = "cornflowerblue", linewidth = 1) +
      add_confidence_interval(fill = "cornflowerblue") +
      add_quantile(y_value = 0.25, linewidth = 0.3) +
      add_quantile(y_value = 0.5, linewidth = 0.8) +
      add_quantile(y_value = 0.75, linewidth = 0.3) +
      labs(x = "Time (days)",
           title = "KM Survival Curve")
    ```
  
d. 
    ```{r}
    km_loglog |>
      quantile(probs = c(0.25, 0.5, 0.75), conf.int = FALSE)
    ```

   Using R, we can see the 25th percentile (22 days), the median or 50th percentile (90 days), and the 75th percentile (180 days). This is shown above on the plot by the horizontal dashed lines.

e. The cumulative hazard can be calculated from the KM survival estimate using the relationship 
    $$
    \hat{\Lambda}_{KM}(t) = -\log{\left(\hat{S}_{KM}(t)\right)}
    $$
    ```{r}
    surv_summary(km_loglog) |>
      mutate(
        km_cumhaz = -log(surv)) |>
      select(time, km_cumhaz)
    ```

f. The Nelson-Aalen cumulative hazard estimate can be calculated using 
    $$
    \hat{\Lambda}_{NA}(t) = \sum_{t_j \leq t}d_j/r_j
    $$
    ```{r}
    na_df = surv_summary(km_loglog) |>
      mutate(
        hazard = n.event / n.risk,
        na_cumhaz = cumsum(hazard)) |> 
      select(time, na_cumhaz)
    
    na_df
    ```

g. Cumulative Hazard plots

    i.
        ```{r warning=FALSE}
        km_loglog |>
          ggsurvplot(data = q2_df, 
                     fun = "cumhaz",
                     title = "Cumulative Hazard Plot",
                     xlab = "Time (days)",
                     palette = "cornflowerblue",
                     ggtheme = theme_bw())
        ```
        
        The cumulative hazard seems to be slightly concave up, which would indicate a slight increase in hazard over time. A Weibull distribution may fit better than an exponential distribution since hazard appears to not be constant.
    
    ii. 
        ```{r warning=FALSE}
        surv_summary(km_loglog) |>
          mutate(
            hazard = n.event / n.risk,
            log_cumhaz = log(cumsum(hazard)),
            log_time = log(time)) |>
          ggplot(aes(x = log_time, y = log_cumhaz)) +
          geom_step(color = "cornflowerblue",
                    linewidth = 1) +
          theme_bw() +
          labs(title = "Log-log Cumulative Hazard Plot",
               x = "log(Time)", 
               y = "log(Cumulative Hazard)")
        ```
        
        Using a $\log \hat{\Lambda}(t)$ vs $\log(t)$ plot can give an idea about what distribution could fit the data. The log cumulative hazard vs. log(time) plot appears roughly linear, meaning a Weibull or exponential distribution could be a good fit. However, for an exponential distribution to fit, the slope should be equal to 1 since hazard is constant. Since the slope seems to be slightly less than 1, an exponential distribution may not fit. However, with the small sample size, it is difficult to be certain, and more observations would help clarify the trend.
        
h. Using the Nelson-Aalen cumulative hazard, the Fleming-Harrington estimator can be calculated through the relationship
   $$
   \hat{S}_{FH}(t) = \exp\left(-\hat{\Lambda}_{NA}(t)\right)
   $$
    ```{r}
    # Data-frame for time and Fleming-Harrington survival estimate
    fh_df = na_df |>
      mutate(fh_surv = exp(-na_cumhaz)) |>
      select(time, fh_surv)
    
    # Data-frame for time and Kaplan-Meier survival estimate
    km_df = surv_summary(km_loglog) |>
      mutate(km_surv = surv) |>
      select(time, km_surv)
    
    # Joining data-frames for comparison
    left_join(fh_df, km_df, by = "time")
    ```
   
    The Fleming-Harrington estimator closely follows the Kaplan-Meier estimator, however remains slightly higher and notably does not drop to 0.

# Question 3

a. The Actuarial Lifetable is constructed manually in R below. The Actuarial Estimate is shown under `act_surv` and is calculated using the function:
    $$
    \hat{S}(t_j) = \prod_{\ell \leq j}\left(1 - \frac{d_{\ell}}{{r}^{\prime}_{\ell}}\right)
    $$
    
    ```{r}
    lifetable_df = q2_df |>
      mutate(
        interval = cut(Value,
                       breaks = seq(0, max(Value) + 30, by = 30),
                       right = FALSE)) |>
      group_by(interval) |>
      summarise(
        d_j = sum(Binary == 1),
        c_j = sum(Binary == 0)) |>
      mutate(
        r_j = nrow(q2_df) - lag(cumsum(d_j + c_j), default = 0),
        rprime_j = r_j - (c_j / 2),
        qhat_j = d_j / rprime_j,
        act_surv = cumprod(1 - qhat_j))
      
    lifetable_df
    ```

b. The hazard function at the midpoint of each time interval can be calculated using:
    $$
    \hat{\lambda}(t_{mj}) = \frac{d_j}{b_j(r^{\prime}_j - d_j/2)}
    $$
   where $b_j$ is the interval width (30).
   
   Adding hazard to the lifetable:
    ```{r}
    lifetable_df = lifetable_df |>
      mutate(
        hazard = d_j / (30 * (rprime_j - (d_j/2))))
        
    lifetable_df
    ```
  
   Plotting hazard over time:
    ```{r}
    lifetable_df |>
      mutate(
        lower = as.numeric(sub("\\[(\\d+),.*", "\\1", interval)),
        upper = as.numeric(sub(".*,([0-9]+)\\)", "\\1", interval)),
        midpoint = (lower + upper) / 2,) |>
      ggplot(aes(x = midpoint, y = hazard)) +
      geom_step(color = "cornflowerblue", linewidth = 1) +
      theme_bw() +
      labs(
        title = "Actuarial Hazard",
        x = "Time (days)",
        y = "Hazard")
    ```
  
c. From the plot above, hazard seems to increase with time. It is relatively stable at first, but starts to increase in the last few intervals. Since an exponential model relies on hazard remaining constant, an exponential model would not be appropriate.

# Question 4

For $T_1$, the definition for starting point is the time in which a patient is placed on the waiting list. The end point, 'transplantation', would be when a patient receives a transplant with at least one HLA mismatch. 

There are several reasons for censoring as stated in the article.

  - Patient receives no transplant by the end of the follow-up period. 
  
  - Patient is removed from the waiting list.
  
  - Patient death.
  
  - Patient receives a 'No-mismatch' transplant or a transplant from a living relative.

Not receiving a transplant by the end of the follow-up period is typical right-censoring and is typically non-informative. The censoring mechanism of patients dropping out of the study, due to death or removal from waiting list could be argued to be informative. Patient drop-out could be due to a number of unknown confounding reasons. Many confounders were already adjusted for, such as age, blood-type, cause of end-stage renal disease, and others, but unknown confounders may remain.

The censoring mechanism for the time until a transplant with at least one HLA mismatch is informative censoring. Patients who receive a no mismatch transplant or a transplant from a relative are censored. This event is directly related to the study and is not independent of the research question and transplantation process.
        